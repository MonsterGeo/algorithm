# 证明主定理

证明分为两部分，第一部分分析递归式，即假定T(n)仅定义在b(b>1)的幂次上。第二部分我们拓展到任意正整数n上。

## 对b的幂次归纳证明主定理

**引理2：** 令$a\geq 1$和$b>1$是常数，$f(n)$是一个定义在$b$的幂次上的非负函数，$T(n)$是定义在$b$的幂上的递归式：

$$
T(n) =  \begin{cases}
    \Theta(1) & \text{if} ~n = 1\\
    aT(n/b)+f(n) &\text{if}~ n = b^i
\end{cases}
$$

其中$i$是正整数。那么
$$
T(n) = \Theta(n^{\log_b a})+ \sum^{\log_b n-1}_{j=0} a^i f(n/b^i)
$$

**proof:** 树的根节点代价为$f(n)$，第一层中每个子节点的代价为$f(n/b)$，一共有$a$个子节点，那么就存在$af(n/b)$的代价。每个子节点又有$a$个子节点并且也是分了b个，那么每个子节点的子节点代价为$f(n/b^2)$，每个子节点分出a个出来，又有a个字节点的子节点，那么就是$a^2f(n/b^2)$个子节点。现在对底层深度的节点$j$，代价都是$f(n/b^j)$，每个节点代价为$T(1) = \Theta(1)$，深度为$\log_b n$，由于$n/b^{\log_b n= 1}$，则树中一共存在$a^{\log_b n} = n^{\log_b a}$个节点。最后把这些代价加起来就证明了一开始的公式了。深度j上的合并总代价是

$$
\sum^{\log_b n-1}_{j = 0}a^j f(n/b^j)
$$

递归树：
```
| -layer 1-     f(n)  
| -layer 2- f(n/b), f(n/b)...,f(n/b)
| -layer 3- af(n/b^2) ,af(n/b^2) ,......,af(n/b^2)
| -layer ...-    ......
log_b n
| -layer j- a^{\log_b n}O(1), a^{\log_b n}O(1),a^{\log_b n}O(1),...,a^{\log_b n}O(1)
```


从递归树上看，主定理的三种情况分别对应以下三种情况：1、树的总代价由叶节点的代价决定；2、树的总代价均匀分布在树的所有层次上；3、树的总代价由根节点的代价决定。

接下来我们给出这个和式增长速度的渐进界

**引理3:** 令$a \geq 1$和$b > 1$是常数，$f(n)$是一个定义在$b$的幂上的非负函数。$g(n)$是定义在$b$的幂次上的函数：

$$
g(n) = \sum^{\log_b n-1}_{j=0} a^j f(n/b^j)
$$

对$b$的幂，$g(n)$有如下渐进界

+ 若对某个常数$\epsilon > 0$有$f(n) = O(n^{\log_b a-\epsilon})$，则$g(n) = O(n^{\log_b a})$。
+ 若$f(n) = \Theta(n^{\log_b a})$，则$g(n) = \Theta(n^{\log_b a}\lg n)$。
+ 若对某个常数$c < 1$和所有足够大的$n$有$af(n/b) \leq c f(n)$，则$g(n) = \Theta(f(n))$


**Proof:** 对情况1，我们有$f(n) = O(n^{\log_b a-\epsilon})$，这意味着$f(n/b^i) = O((n/b^i)^{\log_b a-\epsilon})$，带入$g(n)$则有

$$
g(n) = O\left( \sum_{j=0}^{\log_{b} n-1} a^j \left( \frac{n}{b^j} \right)^{\log_{b} a} \right)
$$

现在，我们稍作一些变换

$$
\begin{array}{ccc}
    \sum_{j=0}^{\log_{b} n-1} a^j \left( \frac{n}{b^j} \right)^{\log_{b} a} & = & n^{\log_b a-\epsilon}\sum^{\log_b n-1}_{j=0} \left( \frac{ab^\epsilon}{b^{\log_b a}}\right)^j \\
    &=& n^{\log_b a-\epsilon}\sum^{\log_b n-1}_{j=0}(b^\epsilon)^j\\
    & =& n^{\log_b a-\epsilon}\left(\frac{b^{\epsilon\log_b n}-1   }{b^\epsilon -1}\right)\\
    &=&n^{\log_b a-\epsilon}\left(\frac{n^\epsilon - 1}{b^\epsilon -1}\right)
\end{array}
$$

其中$b,\epsilon$是常数，因此最后一个表达式重写为$n^{\log_b a-\epsilon}O(n^\epsilon)$，合并之后就有$n^{\log_b a-\epsilon}O(n^\epsilon) = O(n^{\log_b a})$

情况1证明完毕

我们假定情况2下有$f(n)=\Theta(n^{\log_b a})$，因此有$f(n/b^j) = \Theta((n/b^j)^{\log_b a})$，它的渐进界这样求，带入递推式

$$
g(n) = Θ\left( \sum_{j=0}^{\log_b n - 1} a^j \left( \frac{n}{b^j} \right)^{\log_b a} \right)
$$

那么就有

$$
\sum_{j=0}^{\log_b n - 1} a^j \left( \frac{n}{b^j} \right)^{\log_b a} = n^{\log_b a} \sum_{j=0}^{\log_b n - 1} \left( \frac{a}{b^{\log_b a}} \right)^j = n^{\log_b a} \sum_{j=0}^{\log_b n - 1} 1 = n^{\log_b a} \log_b n
$$

$g(n) = \Theta(n^{\log_b a}\log_b n) = n^{\log_b a}\lg n$

情况2得证，现在看情况三

为了能够使用递推式，我们现在有条件对$b$的幂次存在$g(n) = \Omega(f(n))$，因为$af(n/b) \leq c f(n)$，而$g(n)$的定义都是$f(n/b)$。我们可以将其改为$f(n/b) \leq (c/a)f(n)$并迭代$j$次，就有$a^jf(n/b^j) \leq c^jf(n)$。那么我们更改$g(n)$的表达式有

$$
g(n) = \sum_{j=0}^{\log_b n-1} a^j f(n/b^j) \leq \sum_{j=0}^{\log_b n-1} c^j f(n)+O(1) \leq f(n) \sum_{j=0}^{\infty} c^j + O(1) \\
= f(n) \left( \frac{1}{1-c} \right)+O(1) = O(f(n))
$$

我们使用一个$O(1)$表示n足够大的时候这个假设没被覆盖的项。

**引理4：** 令$a\geq 1$和$b>1$是常数，$f(n)$是一个定义在$b$的幂上的非负函数。$T(n)$是定义在$b$的幂上的递归式

$$
T(n) = \begin{cases}
    \Theta(1) & \text{if } n = 1\\
    aT(n/b)+f(n) &\text{if }n = b^i
\end{cases}
$$
其中$i$是正整数。那么对$b$的幂，$T(n)$有如下渐进界

+ 若对某个常数$\epsilon > 0$，有$f(n) = O(n^{\log_b a-\epsilon})$，则$T(n) = \Theta(n^{\log_b a})$
+ 若$f(n) = \Theta(n^{\log_b a})$，则$T(n) = \Theta(n^{\log_b a}\lg n)$
+ 若对某个常数$\epsilon > 0$，有$f(n) = \Omega(n^{\log_b a+\epsilon})$，并且对某个常数$c < 1$和所有足够大的$n$，有$af(n/b) \leq cf(n)$，则$T(n) = \Theta(f(n))$

**证明**，利用引理3，情况1我们带入就有
$$
T(n) = \Theta(n^{\log_b a})+O(n^{\log_b a}) = \Theta(n^{\log_b a})
$$

对于情况2
$$
T(n) = \Theta\left(n^{\log_b a}\right) + \Theta\left(n^{\log_b a} \lg n\right) = \Theta\left(n^{\log_b a} \lg n\right)
$$

情况三
$$
T(n) = \Theta\left(n^{\log_b a}\right) + \Theta(f(n)) = \Theta(f(n))
$$
其中$
f(n) = \Omega\left(n^{\log_b a + \epsilon}\right)
$

## 一般情况的主定理

我们将拓展b到任意的整数。那么递归式下界为
$$
T(n) = aT(\lceil n/b\rceil) + f(n)
$$

上界为
$$
T(n) = aT(\lfloor n/b\lfloor)+f(n)
$$

为了证明一般情况下也适用，我们需要对两个上下界分别证明他们都可以变成引理2的形式

这个下界的递推式如下：

若$n_j$表示序列中第$j$个元素，那么
$$
n_j = \begin{cases}
    n & \text{if } j= 0\\
    \lceil n_{j-1}/b\rceil &\text{if } j> 0
\end{cases}
$$

利用不等式，$\lceil x\rceil \leq x+1$，有

$$
\begin{array}{lll}
    n_0& \leq& n\\
    n_1& \leq & \frac{n}{b}+1\\
    n_2& \leq &\frac{n}{b^2}+\frac{1}{b} + 1 \\
    n_3 & \leq & \frac{n}{b^3}+\frac{1}{b^2}+\frac{1}{b}+1\\
    & \vdots &
 \end{array}
$$

归纳的有，对$n_j$有

$$
n_j \leq \frac{n}{b^j}+\sum^{j-1}_{i = 0}\frac{1}{b^i} < \frac{n}{b^j} + \sum^\infty_{i = 0}\frac{1}{b^i} = \frac{n}{b^j} + \frac{b}{b-1}
$$

令$j = \lfloor \log_b n\rfloor$，可得
$$
n_{\lfloor\log_b n\rfloor} < \frac{n}{b^{\lfloor\log_b n\rfloor}} + \frac{b}{b-1}<\frac{n}{b^{\log_b n-1}}+ \frac{b}{b-1} < \frac{n}{n/b}+\frac{b}{b-1} = b+\frac{b}{b-1} = O(1)
$$

这足以证明在深度$\lfloor \log_b n\rfloor$的时候，问题规模至多是常数

那么对于b是常数的递归树，它的每一层如下：$f(n),af(n_1),a^2f(n_2),\Theta(n^{\log_b a})$

$T(n)$的定义就是
$$
T(n) = \Theta(n^{\log_b a})+\sum^{\lfloor\log_bn\rfloor-1}_{j = 0}a^j f(n_j)
$$

除了$n$是任意整数，我们也没有限制$b$的幂之外，该公式和引理2几乎无异

最后的难点是，我们要证明对$f(n_j) = O((n/b^j)^{\log_b a-\epsilon})$就可以证明情况1，对情况2，$f(n_j) = O(n^{\log_b a}/a^j)$就可以带入情况2的证明。最后，只要对$n > b+b/(b-1)$，$af(\lceil n/b\rceil) \leq cf(n)$成立即可，其中$c < 1$是常数。就有$a^jf(n_j) \leq c^j f(n)$

首先定义
$$
g(n) = \sum_{j=0}^{\lfloor \log_b n \rfloor - 1} a^j f(n_j)
$$

首先对$f(n) = \Theta(n^{\log_b a})$
$$
f(n_j) \leq c\left( \frac{n}{b^j} + \frac{b}{b-1} \right)^{\log_b a} = c\left( \frac{n}{b^j} \left( 1 + \frac{b^j}{n} \cdot \frac{b}{b-1} \right) \right)^{\log_b a} \\
= c\left( \frac{n^{\log_b a}}{a^j} \right) \left( 1 + \left( \frac{b^j}{n} \cdot \frac{b}{b-1} \right) \right)^{\log_b a} \\
\leq c\left( \frac{n^{\log_b a}}{a^j} \right) \left( 1 + \frac{b}{b-1} \right)^{\log_b a} = O\left( \frac{n^{\log_b a}}{a^j} \right)
$$

其中$c(1+b/(b-1))^{\log_b a}$是常数，由于$f(n_j) = O(n^{\log_b a}/a^j) = O(n/b^j)^{\log_b a}$，带入情况2的即可证明完毕。

把情况1放这里是因为复杂些，我们现在要证明对递推式$f(n_j)$有$f(n_j) = O(n/b^j)^{\log_b a-\epsilon}$

对$f(n) = O(n^{\log_b a-\epsilon})$和情况3也是如法炮制

$$
\begin{array}{ccl}
    f(n_j) &\leq& c\left(\frac{n}{b^j}+\frac{b}{b-1}\right)^{\log_b a-\epsilon}\\
    &\leq& c\left(\frac{n^{\log_b a-\epsilon}}{a^j}\right)\left(\frac{b}{b-1}+1\right)^{\log_b a-\epsilon} = O(\frac{n^{\log_b a-\epsilon}}{a^j})
\end{array}
$$